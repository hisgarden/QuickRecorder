#!/bin/bash
# Keychain credential helpers for notarization
# SECURITY: Never stores passwords in files. Uses Keychain or interactive prompts only.
#
# SETUP INSTRUCTIONS:
# 1. Copy this file: cp credentials.sh.example credentials.sh
# 2. Update the keychain service name "hisgarden" to your own identifier
# 3. Store credentials in Keychain:
#    security add-internet-password \
#      -s "your-service-name" \
#      -a "appleid" \
#      -w "your@email.com"
#    security add-internet-password \
#      -s "your-service-name" \
#      -a "notarize" \
#      -w "your-app-specific-password"

# Get Apple ID from Keychain securely
get_apple_id_from_keychain() {
    security find-internet-password -s "your-service-name" -a "appleid" -g 2>/dev/null | \
    grep "acct" | sed 's/.*"\(.*\)".*/\1/'
}

# Get App-Specific Password from Keychain securely (prompts Touch ID/Apple Watch)
get_password_from_keychain() {
    security find-internet-password -s "your-service-name" -a "notarize" -w 2>/dev/null
}

# Prompt for password interactively with masked input (shows asterisks)
prompt_password_masked() {
    local password=""
    local char=""
    
    # Use a simpler approach that works better in shell scripts
    read -s -p "Enter app-specific password: " password
    echo "" >&2
    
    echo "$password"
}

# Main function to get credentials
# Priority: Keychain â†’ .env (Apple ID only) â†’ env vars â†’ interactive prompt
get_credentials() {
    local apple_id=""
    local password=""
    
    # Step 1: Try Keychain first (most secure - uses Touch ID/Apple Watch)
    apple_id=$(get_apple_id_from_keychain)
    password=$(get_password_from_keychain)
    
    if [ -n "$apple_id" ] && [ -n "$password" ]; then
        echo "keychain|$apple_id|$password"
        return 0
    fi
    
    # Step 2: Load Apple ID from .env (but NOT password - it should NEVER be in .env)
    if [ -f ".env" ]; then
        # Only source APPLE_ID and APPLE_TEAM_ID, skip APP_SPECIFIC_PASSWORD
        APPLE_ID=$(grep "^APPLE_ID=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'")
        APPLE_TEAM_ID=$(grep "^APPLE_TEAM_ID=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'")
    fi
    
    # Step 3: Fall back to environment variable for Apple ID
    apple_id="${apple_id:-${APPLE_ID:-}}"
    
    if [ -z "$apple_id" ]; then
        echo "error|||"
        return 1
    fi
    
    # Step 4: Try environment variable for password (only if explicitly set)
    if [ -n "${APP_SPECIFIC_PASSWORD:-}" ]; then
        echo "env|$apple_id|$APP_SPECIFIC_PASSWORD"
        return 0
    fi
    
    # Step 5: If no password in env/keychain, prompt interactively with masked input
    echo "ðŸ” App-specific password not found in Keychain or environment" >&2
    password=$(prompt_password_masked "Enter app-specific password: ")
    
    if [ -z "$password" ]; then
        echo "error|||"
        return 1
    fi
    
    echo "interactive|$apple_id|$password"
    return 0
}

# Verify credentials work with notarytool
verify_credentials() {
    local apple_id=""
    local password=""
    local team_id=""
    
    # Step 1: Get credentials using the standard function
    CREDS=$(get_credentials)
    
    if [ $? -ne 0 ] || [ -z "$CREDS" ]; then
        echo "error|||"
        return 1
    fi
    
    SOURCE=$(echo "$CREDS" | cut -d'|' -f1)
    apple_id=$(echo "$CREDS" | cut -d'|' -f2)
    password=$(echo "$CREDS" | cut -d'|' -f3)
    
    if [ "$SOURCE" = "error" ] || [ -z "$apple_id" ] || [ -z "$password" ]; then
        echo "error|||"
        return 1
    fi
    
    # Step 2: Get Apple ID from .env if not already set (prefer .env over Keychain for clarity)
    if [ -f ".env" ]; then
        ENV_APPLE_ID=$(grep "^APPLE_ID=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'" | tr -d ' ')
        if [ -n "$ENV_APPLE_ID" ]; then
            apple_id="$ENV_APPLE_ID"
        fi
        
        ENV_TEAM_ID=$(grep "^APPLE_TEAM_ID=" .env | cut -d'=' -f2 | tr -d '"' | tr -d "'" | tr -d ' ')
        if [ -n "$ENV_TEAM_ID" ]; then
            team_id="$ENV_TEAM_ID"
        fi
    fi
    
    # Step 3: Fall back to environment variables
    apple_id="${apple_id:-${APPLE_ID:-}}"
    team_id="${team_id:-${APPLE_TEAM_ID:-}}"
    
    # Step 4: Final validation
    if [ -z "$apple_id" ] || [ -z "$password" ]; then
        echo "error|||"
        return 1
    fi
    
    # Return format: success|apple_id|password|team_id
    echo "success|$apple_id|$password|$team_id"
    return 0
}

# If called directly with arguments, handle accordingly
case "${1:-}" in
    apple-id)
        get_apple_id_from_keychain
        ;;
    password)
        get_password_from_keychain
        ;;
    credentials)
        get_credentials
        ;;
    verify)
        verify_credentials
        ;;
    *)
        echo "Usage: $0 {apple-id|password|credentials|verify}"
        exit 1
        ;;
esac

