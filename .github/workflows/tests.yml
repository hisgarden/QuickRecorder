name: Test Suite and Security Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Full Test Suite
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -switch /Applications/Xcode_15.4.app/Contents/Developer || sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Run full test suite
      run: |
        xcodebuild test \
          -project QuickRecorder.xcodeproj \
          -scheme QuickRecorder \
          -destination 'platform=macOS' \
          -enableCodeCoverage YES
          
    - name: Build app for visual check
      run: |
        xcodebuild build \
          -project QuickRecorder.xcodeproj \
          -scheme QuickRecorder \
          -configuration Debug \
          -derivedDataPath ./build
          
    - name: Verify app bundle exists
      run: |
        if [ -d "build/Build/Products/Debug/QuickRecorder.app" ]; then
          echo "✅ App bundle created successfully"
          ls -lh build/Build/Products/Debug/QuickRecorder.app/Contents/MacOS/QuickRecorder
        else
          echo "❌ App bundle not found"
          exit 1
        fi
          
    - name: Generate test report
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "✅ Full test suite completed" >> $GITHUB_STEP_SUMMARY
        
  security:
    name: Security and Permission Tests
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -switch /Applications/Xcode_15.4.app/Contents/Developer || sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer
      
    - name: Run security tests
      run: |
        xcodebuild test \
          -project QuickRecorder.xcodeproj \
          -scheme QuickRecorder \
          -destination 'platform=macOS' \
          -only-testing:QuickRecorderTests/PermissionBehaviorTests \
          -only-testing:QuickRecorderTests/ErrorHandlerTests
          
    - name: Security code analysis
      run: |
        echo "## Security Analysis" >> $GITHUB_STEP_SUMMARY
        echo "### Force Unwraps Check" >> $GITHUB_STEP_SUMMARY
        FORCE_UNWRAPS=$(grep -r "!" --include="*.swift" QuickRecorder/ | grep -v "//" | grep -v "Test" | wc -l | tr -d ' ')
        echo "Found: $FORCE_UNWRAPS potential force unwraps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Assertion Failures Check" >> $GITHUB_STEP_SUMMARY
        ASSERTION_FAILURES=$(grep -r "assertionFailure" --include="*.swift" QuickRecorder/ | grep -v "Test" | wc -l | tr -d ' ')
        echo "Found: $ASSERTION_FAILURES assertionFailure calls" >> $GITHUB_STEP_SUMMARY
        
  code-quality:
    name: Code Quality Checks
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for build errors
      run: |
        xcodebuild clean build \
          -project QuickRecorder.xcodeproj \
          -scheme QuickRecorder \
          -destination 'platform=macOS' \
          -configuration Debug
          
    - name: Lint check
      run: |
        echo "## Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "✅ Build successful" >> $GITHUB_STEP_SUMMARY
        echo "✅ No compilation errors" >> $GITHUB_STEP_SUMMARY

